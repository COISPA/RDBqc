---
title: "![](logo.png){width=6in}<br>\\vspace{2in}\n\n\n\n`r format(params$term)` Report\\vspace{0.1in} "

date: "Compiled on `r format(Sys.time(), '%d/%m/%Y, %H:%M')`"
subtitle: ''

output:
  html_document:
    template: RDBFIS_report_template.html
    toc: true
    toc-title: "Table of contents"
    toc_depth: 5
    number_sections: true
    collapsed: true
    df_print: paged
params:
  term: MEDBS datacall
---
<!-- INITIALIZATION -->

```{r inizialization, include=FALSE}
knitr::opts_chunk$set(
  echo = FALSE,
  message = FALSE,
  warning = FALSE
)
```


```{r libraries, include=FALSE}
# loading needed libraries
lib <- c("RDBqc", "knitr", "kableExtra", "dplyr", "ggplot2", "rworldmap", "sp", "rworldxtra", "pander", "data.table", "grDevices", "magrittr", "tictoc", "tidyverse", "fishmethods", "tidyr", "gridExtra","readr")
lapply(lib, require, character.only = TRUE)
```

<!-- USER DEFINED SOURCE FILES -->

```{r setup, include=FALSE}

# reading files
# UNCOMMENT  THE FOLLOWING LINES FOR STAND-ALONE USE
# SELECT THE APPROPRIATE FILE PATHS ON THE LOCAL FOLDERS

Catch <- read.coded.file("./catch.csv", sep = ",")
Land <- read.coded.file("./landings.csv", sep = ",")
Disc <- read.coded.file("./discards.csv", sep = ",")
ML <- read.coded.file("./ml.csv", sep = ",")
MA <- read.coded.file("./ma.csv", sep = ",")
SL <- read.coded.file("./srl.csv", sep = ",")
SA <- read.coded.file("./sra.csv", sep = ",")
GP <- read.coded.file("./gp.csv", sep = ",")
ALK <- read.coded.file("./alk.csv", sep = ",")

SPs <- c("MUT")
MS <- "ITA"
GSAs <- "GSA 18"
end_year <- 2021
```


```{r filters, include=FALSE}
# check the presence of user defined filter for species (SPs)
if (exists("SPs")) {
  if (length(SPs) == 1 & is.na(SPs[1])) {
    user_SP <- FALSE
  } else {
    user_SP <- TRUE
  }
} else {
  user_SP <- FALSE
}

# check the presence of user defined filter for member state (MS)
if (exists("MS")) {
  if (length(MS) == 1 & is.na(MS[1])) {
    user_MS <- FALSE
  } else {
    user_MS <- TRUE
  }
} else {
  user_MS <- FALSE
}

# check the presence of user defined filter for sub-area (GSAs)
if (exists("GSAs")) {
  if (length(GSAs) == 1 & is.na(GSAs[1])) {
    user_GSA <- FALSE
  } else {
    user_GSA <- TRUE
  }
} else {
  user_GSA <- FALSE
}

# check the presence of user defined value for 'SOP_threshold'
if (exists("SOP_threshold")) {
  if (length(SOP_threshold) == 1 & is.na(SOP_threshold[1])) {
    SOP_threshold <- 5
  }
} else {
  SOP_threshold <- 5
}

# check the presence of user defined value for 'Rt'
if (exists("Rt")) {
  if (length(Rt) == 1 & is.na(Rt[1])) {
    Rt <- 1
  }
} else {
  Rt <- 1
}
```

\newpage
<!-- CATCH -->

```{r check_catch_data, results = 'asis'}

if (exists("Catch")) {
  if (class(Catch) == "data.frame") {
    if (nrow(Catch) > 0) {
      check_Catch <- TRUE
      colnames(Catch) <- tolower(colnames(Catch))
      cat(paste0("\n# Catch table\n"))
      if (!user_SP) {
        SPs <- sort(unique(Catch$species))
      }
      if (!user_MS) {
        MS <- unique(Catch$country)
      }
      if (!user_GSA) {
        GSAs <- sort(unique(Catch$area))
      }
    } else {
      check_Catch <- FALSE
      cat("\n No catch data available \n")
    }
  }
} else {
  check_Catch <- FALSE
  cat("\n No catch data available \n")
}
```



```{r catch_duplicated_records, results = 'asis'}
if (check_Catch) {
  cat("\n## No replicated records in Catch data\n")
  cat("\nData included in the catch table were checked for the presence of duplicated records. The result of the check is here reported:\n")

  duplicates <- Catch[0, ]

  g <- 1
  for (g in 1:length(GSAs)) {
    s <- 1
    for (s in 1:length(SPs)) {
      res <- MEDBS_check_duplicates(data = Catch, type = "c", SP = SPs[s], MS = MS, GSA = GSAs[g], verbose = FALSE)
      if (!is.null(res)) {
        duplicates <- rbind(duplicates, res)
      }
    }
  }

  if (nrow(duplicates) > 0) {
    cat("\n", paste0("- _WARNING_ - ", nrow(duplicates), " replicated record/records in the data"), "\n")
    duplic <- data.frame(id = duplicates[, 1])
    print(duplic %>% kable("html") %>% kable_styling(font_size = 12) %>% kable_classic(full_width = TRUE))
    Catch <- Catch[-which(rownames(Catch) %in% as.numeric(rownames(duplicates))), ]
  } else {
    cat("\n", paste0("- No replicated records in Catch data"), "\n")
  }

  cat("\n*Attention*: eventual duplicated records will be removed from catch data for the following analysis \n")
} # check_Catch
```


```{r catch_disaggregated_records, results = 'asis'}
if (check_Catch) {
  cat("\n## Presence of disaggregated records\n")
  cat("\nData included in the catch table were checked for the presence of disaggregated records. The result of the check is here reported:\n")

  disaggregated <- Catch[0, ]

  g <- 1
  for (g in 1:length(GSAs)) {
    s <- 1
    for (s in 1:length(SPs)) {
      res <- MEDBS_check_disaggregated(data = Catch, type = "c", SP = SPs[s], MS = MS, GSA = GSAs[g], verbose = FALSE)
      if (!is.null(res)) {
        disaggregated <- rbind(disaggregated, res)
      }
    }
  }

  if (nrow(disaggregated) > 0) {
    cat("\n", paste0("- _WARNING_ - ", nrow(disaggregated), " disaggregated record/records in the data"), "\n")
    print(disaggregated %>% kable("html") %>% kable_styling(font_size = 12) %>% kable_classic(full_width = TRUE))
  } else {
    cat("\n", paste0("- No disaggregated records in Catch data"), "\n")
  }

} # check_Catch
```

```{r catch_missing_years, results = 'asis'}
if (check_Catch) {
  cat("\n## Check missing years in time series\n")
  cat("\nData where checked for the continuity of the time series, identifying the presence of missing years:\n")

  g <- 1
  for (g in 1:length(GSAs)) {
    s <- 1
    for (s in 1:length(SPs)) {
      res <- MEDBS_check_missing_years(data = Catch, end_year, type = "c", SP = SPs[s], MS = MS, GSA = GSAs[g], verbose = FALSE)
      if (!is.null(res)) {
        if (length(res)>0) {
           cat(paste0("\n- The following years are missing in the Catch data time series (", SPs[s], " - ", MS, " - ", GSAs[g], "): ",paste(res,collapse=", "),"\n")) 
        } else {
          cat(paste0("\n- No missing years in the Catch data time series for the selected combination: ", SPs[s], " - ", MS, " - ", GSAs[g], "\n"))  
        }
      } else {
       cat(paste0("\n- No Catch data for the selected combination: ", SPs[s], " - ", MS, " - ", GSAs[g], "\n"))
      }
    } # for cycle SP
  } # for cycle GSA
} # check_Catch
```

```{r catch_coverage, results = 'asis',fig.height=6,fig.width=9}

if (check_Catch) {
  cat("\n## Catch data time series\n")

  for (g in 1:length(GSAs)) {
    cat(paste0("\n### ", GSAs[g], "\n"))
    s <- 1
    for (s in 1:length(SPs)) {
      cat(paste0("\n#### ", SPs[s], "\n"))
      res <- suppressMessages(MEDBS_Catch_coverage(Catch, SP = SPs[s], MS = MS, GSA = GSAs[g]))
      tab1 <- res[[1]]
      tab2 <- res[[2]]

      if (!is.null(res)) {
        suppressMessages(tab1 <- data.frame(tab1 %>% group_by(country, year, area, species) %>% summarise(landings = sum(landings, na.rm = TRUE))))

        if (nrow(tab1) > 0) {
          cat(paste0("\n_Coverage of landing data for ", SPs[s], " in ", GSAs[g], "_\n"))

          print(tab1 %>% kable("html") %>% kable_styling(font_size = 12) %>% kable_classic(full_width = TRUE))

          cat("\n\n\n")
          print(res[[3]])
          cat("\n\n\n")
        } else {
          cat("\n\n\n- No data for landings")
        }

        suppressMessages(tab2 <- data.frame(tab2 %>% group_by(country, year, area, species) %>% summarise(discards = sum(discards, na.rm = TRUE))))
        if (nrow(tab2) > 0) {
          cat(paste0("\n_Coverage of discard data for ", SPs[s], " in ", GSAs[g], "_"))
          print(tab2 %>% kable("html") %>% kable_styling(font_size = 12) %>% kable_classic(full_width = TRUE))
          cat("\n\n\n")

          print(res[[4]])
          cat("\n\n\n")
        } else {
          cat("\n\n\n- No data for discards")
        }
      } else {
        cat(paste0("\n- No Catch data for the selected combination: ", SPs[s], " - ", MS, " - ", GSAs[g], "\n"))
      }
    }
  }
} # check_Catch
```


```{r catch_SOP, results = 'asis',fig.height=6,fig.width=9}
if (check_Catch) {
  cat("\n## Check of Sum of Products (SOP)\n")
  cat(paste0("\nRecords for which the Sum Of Product (SOP) in weight differs in absolute terms more then ", SOP_threshold, "% threshold chosen from the landings or discards volumes declared.\n"))

  for (g in 1:length(GSAs)) {
    cat(paste0("\n### ", GSAs[g], "\n"))
    s <- 1
    for (s in 1:length(SPs)) {
      cat(paste0("\n#### ", SPs[s], "\n"))
      res <- suppressMessages(MEDBS_SOP(data=Catch, SP = SPs[s], MS = MS, GSA = GSAs[g], threshold = SOP_threshold, verbose = FALSE))

      if (nrow(res) > 0) {
        cat(paste0("\n_Critical values of SOP for ", SPs[s], " in ", GSAs[g], "_\n\n"))
        print(res %>% kable("html") %>% kable_styling(font_size = 12) %>% kable_classic(full_width = TRUE))
      } else {
        cat(paste0("\n_No critical values of SOP detected for ", SPs[s], " in ", GSAs[g], "_\n\n"))
      }
    }
  }
} # check_Catch
```

<!-- LANDING -->

```{r check_landing_data, results = 'asis'}

if (exists("Land")) {
  if (class(Land) == "data.frame") {
    if (nrow(Land) > 0) {
      check_Land <- TRUE
      colnames(Land) <- tolower(colnames(Land))
      cat(paste0("\n# Landing table\n"))
      if (!user_SP) {
        SPs <- sort(unique(Land$species))
      }
      if (!user_MS) {
        MS <- sort(unique(Land$country))
      }
      if (!user_GSA) {
        GSAs <- sort(unique(Land$area))
      }
    } else {
      check_Land <- FALSE
      cat("\n No Landing data available \n")
    }
  }
} else {
  check_Land <- FALSE
  cat("\n No Landing data available \n")
}
```

```{r landings_duplicated_records, results = 'asis'}
if (check_Land) {
  cat("\n## No replicated records in Landing data \n")
  cat("\nData included in the landing table were checked for the presence of duplicated records. The result of the check is here reported:\n")

  duplicates <- Land[0, ]

  for (g in 1:length(GSAs)) {
    s <- 1
    for (s in 1:length(SPs)) {
      # cc <- Catch[Catch$AREA== GSAs[g]&Catch$SPECIES==SPs[s],]
      # Catch <- rbind(Catch,cc[1,])
      res <- MEDBS_check_duplicates(data = Land, type = "l", SP = SPs[s], MS = MS, GSA = GSAs[g], verbose = FALSE)
      if (!is.null(res)) {
        duplicates <- rbind(duplicates, res)
      }
    }
  }

  if (nrow(duplicates) > 0) {
    cat("\n", paste0("- _WARNING_ - ", nrow(duplicates), " replicated record/records in the data"), "\n")
    duplic <- data.frame(id = duplicates[, 1])
    print(duplic %>% kable("html") %>% kable_styling(font_size = 12) %>% kable_classic(full_width = TRUE))
    Land <- Land[-which(rownames(Land) %in% as.numeric(rownames(duplicates))), ]
  } else {
    cat("\n", paste0("- No replicated records in Landings data"), "\n")
  }
} # check_Land
```

```{r landings_disaggregated_records, results = 'asis'}
if (check_Land) {
  cat("\n## Presence of disaggregated records\n")
  cat("\nData included in the landings table were checked for the presence of disaggregated records. The result of the check is here reported:\n")

  disaggregated <- Land[0, ]

  g <- 1
  for (g in 1:length(GSAs)) {
    s <- 1
    for (s in 1:length(SPs)) {
      res <- MEDBS_check_disaggregated(data = Land, type = "l", SP = SPs[s], MS = MS, GSA = GSAs[g], verbose = FALSE)
      if (!is.null(res)) {
        disaggregated <- rbind(disaggregated, res)
      }
    }
  }

  if (nrow(disaggregated) > 0) {
    cat("\n", paste0("- _WARNING_ - ", nrow(disaggregated), " disaggregated record/records in the data"), "\n")
    print(disaggregated %>% kable("html") %>% kable_styling(font_size = 12) %>% kable_classic(full_width = TRUE))
  } else {
    cat("\n", paste0("- No disaggregated records in landings data"), "\n")
  }

} # check_Land
```


```{r land_missing_years, results = 'asis'}
if (check_Land) {
  cat("\n## Check missing years in time series\n")
  cat("\nLanding data where checked for the continuity of the time series, identifying the presence of missing years:\n")

  g <- 1
  for (g in 1:length(GSAs)) {
    s <- 1
    for (s in 1:length(SPs)) {
      res <- MEDBS_check_missing_years(data = Land, end_year=end_year, type = "l", SP = SPs[s], MS = MS, GSA = GSAs[g], verbose = FALSE)
      if (!is.null(res)) {
        if (length(res)>0) {
           cat(paste0("\n- The following years are missing in the landings data time series (", SPs[s], " - ", MS, " - ", GSAs[g], "): ",paste(res,collapse=", "),"\n")) 
        } else {
          cat(paste0("\n- No missing years in the landings data time series for the selected combination: ", SPs[s], " - ", MS, " - ", GSAs[g], "\n"))  
        }
      } else {
       cat(paste0("\n- No disclandingsrds data for the selected combination: ", SPs[s], " - ", MS, " - ", GSAs[g], "\n"))
      }
    } # for cycle SP
  } # for cycle GSA
} # check_Land
```


```{r landing_coverage, results = 'asis',fig.height=6,fig.width=9}
if (check_Land) {
  cat("\n## Landing data time series\n")

  g <- 1
  for (g in 1:length(GSAs)) {
    cat(paste0("\n### ", GSAs[g], "\n"))
    s <- 3
    for (s in 1:length(SPs)) {
      cat(paste0("\n#### ", SPs[s], "\n"))
      res <- suppressMessages(MEDBS_Landing_coverage(Land, SP = SPs[s], MS = MS, GSA = GSAs[g]))


      if (!is.null(res)) {
        tab1 <- res[[1]]
        tab1 <- aggregate(tab1$landings, by = list(tab1$country, tab1$year, tab1$area, tab1$gear, tab1$species), FUN = "sum")
        colnames(tab1) <- c("country", "year", "area", "gear", "species", "landings")
        if (nrow(tab1) > 0) {
          cat(paste0("\n_Coverage of landing data for ", SPs[s], " in ", GSAs[g], "_"))
          print(tab1 %>% kable("html") %>% kable_styling(font_size = 12) %>% kable_classic(full_width = TRUE))
          cat("\n\n\n")
        } else {
          cat("\n\n\n- No data for landings")
        }
        print(res[[2]])
        cat("\n\n\n")
      } else {
        cat(paste0("\n- No Landings data for the selected combination: ", SPs[s], " - ", MS, " - ", GSAs[g], "\n"))
      }
    }
  }
} # check_Land
```

```{r comp_Q_VL_fishery, results = 'asis', fig.height=6, fig.width=9}
if (check_Land) {
  cat("\n## Checks on landing volumes\n")
  cat("\n### Comparison of landing volumes aggregated by quarters at metier and vessel length levels\n")
g=1
  for (g in 1:length(GSAs)) {
    cat(paste0("\n#### ", GSAs[g], "\n"))
    s <- 1
    for (s in 1:length(SPs)) {
      cat(paste0("\n##### ", SPs[s], "\n"))
      res <- suppressMessages(MEDBS_comp_land_Q_VL_fishery(data = Land, MS = MS, GSA = GSAs[g], SP = SPs[s]))
      if (nrow(res) > 0) {
        res <- res[!is.na(res$ratio) & res$ratio >= 0.95 & res$ratio <= 1.05, ] # res$ratio > 0
      }
      if (nrow(res) > 0) {
        cat(paste0("\n_Summary table reporting the record in which the ratio values are equal or close (5% deviation) to 1 for ", SPs[s], " in ", GSAs[g], "_"))
        print(res %>% kable("html") %>% kable_styling(font_size = 12) %>% kable_classic(full_width = TRUE))
      } else {
        cat(paste0("\n- No table reported means that no issues were identified in data for: ", SPs[s], " - ", MS, " - ", GSAs[g], "\n"))
      }
    }
  }
} # check_Land
```

```{r comp_YQ_fishery, results = 'asis', fig.height=6, fig.width=9}
if (check_Land) {
  cat("\n### Comparison between landings in weight reported by quarter and at year time frame by gear and fishery combination\n")

  for (g in 1:length(GSAs)) {
    cat(paste0("\n### ", GSAs[g], "\n"))
    s <- 1
    for (s in 1:length(SPs)) {
      cat(paste0("\n#### ", SPs[s], "\n"))
      res <- suppressMessages(MEDBS_comp_land_YQ_fishery(data = Land, MS = MS, GSA = GSAs[g], SP = SPs[s]))
      if (nrow(res) > 0){
         res <- res[!is.na(res$ratio) & res$ratio >= 0.95 & res$ratio <= 1.05,  ]
      }
      if (nrow(res) > 0) {
        cat(paste0("\n_Summary table reporting the records in which the ratio values are equal or close (5% deviation) to 1 for ", SPs[s], " in ", GSAs[g], "_"))
        print(res %>% kable("html") %>% kable_styling(font_size = 12) %>% kable_classic(full_width = TRUE))
      } else {
        cat(paste0("\n- No table reported means that no issues were identified for the selected combination: ", SPs[s], " - ", MS, " - ", GSAs[g], "\n"))
      }
    }
  }
} # check_Land
```

```{r KS_test_land, results = 'asis', fig.height=6, fig.width=9}

if (check_Land) {
  cat("\n## Kolmogorov-Smirnov test of landings LFDs\n")
  cat("\nThe Kolmogorov-Smirnov test provides cumulative length distribution plots by fishery and year. The test is performed on couples of years to assess if their distributions belong to the same population. The table reports only the cases in which the distribution does not belong to the same population in the given comparison.\n")

  for (g in 1:length(GSAs)) {
    cat(paste0("\n### ", GSAs[g], "\n"))
    s <- 1
    for (s in 1:length(SPs)) {
      cat(paste0("\n#### ", SPs[s], "\n"))
      res <- suppressMessages(MEDBS_ks(data = Land, type = "l", SP = SPs[s], MS = MS, GSA = GSAs[g], Rt = Rt))

      if (class(res) == "list" & length(res) > 0) {
        cat("\n\n\n")
        cat(paste0("\nPlot of cumulative length distributions by fishery and year for ", SPs[s], " - ", MS, " - ", GSAs[g], "\n"))
        print(res[[4]])
        cat("\n\n\n")


        # cat(paste0("\n_Summary table of Kolmogorov-Smirnov test for ", SPs[s], " in ", GSAs[g], "_\n"))
        # tab1 <- res[[2]]
        # tab1 <- tab1[tab1$Comment == "not belong to same population", ]
        # print(tab1 %>% kable("html") %>% kable_styling(font_size = 12) %>% kable_classic(full_width = TRUE))
      } else {
        cat(paste0("\n- No Kolmogorov-Smirnov test results are available for the selected combination: ", SPs[s], " - ", MS, " - ", GSAs[g], ".\n"))
      }
    }
  }
} # check_Land
```



```{r length_ind_land, results = 'asis', fig.height=6, fig.width=9}
if (check_Land) {
  cat("\n## Main length size indicators\n")
  cat(paste0("\nThe time series of the main length size indicators (mean and median length) by fishery was estimated and hereafter reported: \n"))

  for (g in 1:length(GSAs)) {
    cat(paste0("\n### ", GSAs[g], "\n"))
    s <- 1
    for (s in 1:length(SPs)) {
      cat(paste0("\n#### ", SPs[s], "\n"))
      res <- suppressMessages(MEDBS_length_ind(data = Land, type = "l", MS = MS, GSA = GSAs[g], SP = SPs[s], splines = c(0.2, 0.4, 0.6, 0.8), Xtresholds = c(0.25, 0.5, 0.75)))

      if (class(res) == "list" & length(res) > 0) {
        # cat(paste0("\n_Summary table of Main length size indicators for ", SPs[s], " in ", GSAs[g], "_"))
        # print(res[[1]] %>% kable("html") %>% kable_styling(font_size = 12) %>% kable_classic(full_width = TRUE))

        name <- names(res)
        list_name <- strsplit(name, " _ ")
        short_list <- NULL
        n <- 1
        for (n in 1:length(list_name)) {
          short_list[n] <- list_name[[n]][1]
        }
        index <- which(short_list %in% c("MeanLength","MedianLength","25th.perc","75th.perc","MinLength","MaxLength"))

        x <- 3
        for (x in index) {
          text <- strsplit(name[[x]], " _ ")[[1]][1]
          cat(paste0("\nPlot of ", short_list[x], " for ", SPs[s], " - ", MS, " - ", GSAs[g], "\n"))
          suppressMessages(print(res[[x]]))
          cat("\n\n\n")
        }
      } else {
        cat(paste0("\n- No main length size indicators estimated for the selected combination: ", SPs[s], " - ", MS, " - ", GSAs[g], ".\n"))
      }
    }
  }
} # check_Land
```

```{r lengthclass_0_land, results = 'asis', fig.height=6, fig.width=9}
if (check_Land) {
  cat("\n## Check the number of records for which no demographic structure has been reported\n")
  cat("\nThe presence of length classes numbers zero having weigth > 0 in landings is here reported:\n")

  for (g in 1:length(GSAs)) {
    cat(paste0("\n### ", GSAs[g], "\n"))
    s <- 1
    for (s in 1:length(SPs)) {
      cat(paste0("\n#### ", SPs[s], "\n"))
      res <- suppressMessages(MEDBS_lengthclass_0(data = Land, type = "l", MS = MS, GSA = GSAs[g], SP = SPs[s]))
      if (nrow(res) > 0) {
        ll <- Land
        colnames(ll) <- tolower(colnames(ll))
        cat(paste0("\n_",nrow(res)," landing records in which length class numbers are 0 for ", SPs[s], " in ", GSAs[g], " over a total of ",nrow(ll[ll$country == MS & ll$area==GSAs[g] & ll$species ==SPs[s], ])," rows_"))
        # print(res %>% kable("html") %>% kable_styling(font_size = 12) %>% kable_classic(full_width = TRUE))
      } else {
        cat(paste0("\n- No landing records with 0 length class values having weigth > 0 for : ", SPs[s], " - ", MS, " - ", GSAs[g], "\n"))
      }
    }
  }
} # check_Land
```


```{r yr_missing_length_land, results = 'asis', fig.height=6, fig.width=9}
if (check_Land) {
  cat("\n## Check the presence of years with missing length distribution\n")
  cat("\nLanding data were checked to identify the presence of years with missing length distributions. The years with the missing length distribution are reported in the following table (if any):\n")

  g=1
  for (g in 1:length(GSAs)) {
    cat(paste0("\n### ", GSAs[g], "\n"))
    s <- 1
    for (s in 1:length(SPs)) {
      cat(paste0("\n#### ", SPs[s], "\n"))
      res <- suppressMessages(MEDBS_yr_missing_length(data = Land, type = "l", MS = MS, GSA = GSAs[g], SP = SPs[s]))
      if (!is.null(res) & length(res)!=0) {
          
          if (!is.null(res[[1]]) ) {
              if (length(res)>1) {
               cat(paste0("\n- No length distributions available for the following years: ", ifelse(is.na(res[[2]][1]),"NONE",paste(res[[2]],collapse = ", ")), "\n"))
              }
          } else {
                  cat(paste0("\n- No length distributions available in landings for the selected combination: ", SPs[s], " - ", MS, " - ", GSAs[g], ".\n"))
          }
          
          
        if (!is.null(res[[1]])) {
          cat(paste0("\n_Metiers in which no length distribution is available for ", SPs[s], " in ", GSAs[g], "_"))
          print(res[[1]] %>% kable("html") %>% kable_styling(font_size = 12) %>% kable_classic(full_width = TRUE))
        } else {
          cat(paste0("\n- No metiers in landings with missing length distribution for : ", SPs[s], " - ", MS, " - ", GSAs[g], "\n"))
        }
      } else {
        cat(paste0("\n- No years in landings with missing length distribution for : ", SPs[s], " - ", MS, " - ", GSAs[g], "\n"))
      }
    }
  }
} # check_Land
```



```{r weight_0_land, results = 'asis', fig.height=6, fig.width=9}
if (check_Land) {
  cat("\n## Check if there are landings in weight equal to zero having length class filled in\n")
  cat("\nThe presence of rows in landing with 0 values in weights having length classes filled in is reported in the following table:\n")

  for (g in 1:length(GSAs)) {
    cat(paste0("\n### ", GSAs[g], "\n"))
    s <- 1
    for (s in 1:length(SPs)) {
      cat(paste0("\n#### ", SPs[s], "\n"))
      res <- MEDBS_weight_0(data = Land, type = "l", MS = MS, GSA = GSAs[g], SP = SPs[s], verbose = FALSE)
      if (nrow(res) > 0) {
        cat(paste0("\n_Landing records in weight equal to 0 having length classes filled in for ", SPs[s], " in ", GSAs[g], "_"))
        print(res %>% kable("html") %>% kable_styling(font_size = 12) %>% kable_classic(full_width = TRUE))
      } else {
        cat(paste0("\n- No landing records in weight equal to 0 having length classes filled in for : ", SPs[s], " - ", MS, " - ", GSAs[g], "\n"))
      }
    }
  }
} # check_Land
```

```{r weight_minus1_land, results = 'asis', fig.height=6, fig.width=9}
if (check_Land) {
  cat("\n## Check if there are landings in weight equal to -1 having length class filled in\n")
  cat("\nThe presence of rows in landing with -1 values in weights having length classes filled in is reported in the following table:\n")

  g <- 2
  for (g in 1:length(GSAs)) {
    cat(paste0("\n### ", GSAs[g], "\n"))
    s <- 1
    for (s in 1:length(SPs)) {
      cat(paste0("\n#### ", SPs[s], "\n"))
      res <- MEDBS_weight_minus1(data = Land, type = "l", MS = MS, GSA = GSAs[g], SP = SPs[s], verbose = FALSE)
      if (nrow(res) > 0) {
        cat(paste0("\n_Landing records in weight equal to -1 having length classes filled in for ", SPs[s], " in ", GSAs[g], "_"))
        print(res %>% kable("html") %>% kable_styling(font_size = 12) %>% kable_classic(full_width = TRUE))
      } else {
        cat(paste0("\n- No landing records in weight equal to -1 having length classes filled in for : ", SPs[s], " - ", MS, " - ", GSAs[g], "\n"))
      }
    }
  }
} # check_Land
```

```{r land_mean_weight_land, results = 'asis', fig.height=6, fig.width=9}
if (check_Land) {
  cat("\n## Mean weight by year, gear and fishery aggregation\n")
  cat(paste0("\n Landing data were checked to assess the consistency of mean species landing weight by year, gear and fishery.\n"))

  for (g in 1:length(GSAs)) {
    cat(paste0("\n### ", GSAs[g], "\n"))
    s <- 1
    for (s in 1:length(SPs)) {
      cat(paste0("\n#### ", SPs[s], "\n"))
      res <- suppressMessages(MEDBS_land_mean_weight(data = Land, MS = MS, GSA = GSAs[g], SP = SPs[s]))

      if (class(res) == "list" & length(res) > 0) {
        if (!is.null(res[[1]])) {
          cat(paste0("\n_Summary table of Main landing weights for ", SPs[s], " in ", GSAs[g], "_"))
          print(res[[1]] %>% kable("html") %>% kable_styling(font_size = 12) %>% kable_classic(full_width = TRUE))
        } else {
          cat(paste0("\n- No main weights estimated for the selected combination: ", SPs[s], " - ", MS, " - ", GSAs[g], ".\n"))
        }
        if (length(res) > 1) {
          cat(paste0("\nPlot of landing mean weights for ", SPs[s], " - ", MS, " - ", GSAs[g], "\n"))
          suppressMessages(print(res[[2]]))
          cat("\n\n\n")
        } else {
          cat(paste0("\n- No main weights estimated for the selected combination: ", SPs[s], " - ", MS, " - ", GSAs[g], ".\n"))
        }
      } else {
        cat(paste0("\n- No main weights estimated for the selected combination: ", SPs[s], " - ", MS, " - ", GSAs[g], ".\n"))
      }
    }
  }
} # check_Land
```

```{r plot_landing_ts, results = 'asis', fig.height=6, fig.width=9}
if (check_Land) {
  cat("\n## Total landing time series by quarter\n")
  cat(paste0("\nTo identify possible inconsistencies in landing data, the species time series of landing volumes is here plotted by quarter.\n"))

  g <- 1
  for (g in 1:length(GSAs)) {
    cat(paste0("\n### ", GSAs[g], "\n"))
    s <- 1
    for (s in 1:length(SPs)) {
      cat(paste0("\n#### ", SPs[s], "\n"))
      res <- suppressMessages(MEDBS_plot_landing_ts(data = Land, MS = MS, GSA = GSAs[g], SP = SPs[s], by = "quarter"))

      if (length(res) > 0) {
        cat(paste0("\nPlot of total landings for ", SPs[s], " - ", MS, " - ", GSAs[g], "\n"))
        print(res)
        cat("\n\n\n")
      } else {
        cat(paste0("\n- No total landing time series estimated for the selected combination: ", SPs[s], " - ", MS, " - ", GSAs[g], ".\n"))
      }
    }
  }
} # check_Land
```

```{r plot_land_vol, results = 'asis', fig.height=6, fig.width=9}
if (check_Land) {
  cat("\n## Total landing time series by gear and fishery\n")
  cat(paste0("\nTo identify possible inconsistencies in landing data, the species time series of landing volumes is here plotted by fishery and gear.\n"))

  g <- 1
  for (g in 1:length(GSAs)) {
    cat(paste0("\n### ", GSAs[g], "\n"))
    s <- 1
    for (s in 1:length(SPs)) {
      cat(paste0("\n#### ", SPs[s], "\n"))
      res <- suppressMessages(MEDBS_plot_land_vol(data = Land, MS = MS, GSA = GSAs[g], SP = SPs[s]))

      if (length(res) > 0) {
        cat(paste0("\nPlot of total landings for ", SPs[s], " - ", MS, " - ", GSAs[g], "\n"))
        suppressMessages(print(res))
        cat("\n\n\n")
      } else {
        cat(paste0("\n- No total landing time series estimated for the selected combination: ", SPs[s], " - ", MS, " - ", GSAs[g], ".\n"))
      }
    }
  }
} # check_Land
```


```{r plot_land_LFD, results = 'asis', fig.height=6, fig.width=9}
if (check_Land) {
  cat("\n## Landing Length Frequency Distribution\n")
  cat(paste0("\nTo identify possible inconsistencies in landing lengths structure, the species' LFDs are here plotted by fishery and year\n"))

  g <- 1
  for (g in 1:length(GSAs)) {
    cat(paste0("\n### ", GSAs[g], "\n"))
    s <- 1
    for (s in 1:length(SPs)) {
      cat(paste0("\n#### ", SPs[s], "\n"))
      res <- suppressMessages(MEDBS_LFD(data = Land, data2=NA, type="l", MS = MS, GSA = GSAs[g], SP = SPs[s], OUT=FALSE, verbose = TRUE))

      
      
            if (class(res) == "list" & length(res) > 0) {
              
              content <- strsplit(names(res),"_")
              lcontent <- max(lengths(content))
              u=5
              for (u in 1:length(content)) {
                if (lengths(content[u])< lcontent){
                  content[[u]][(lengths(content[u])+1):lcontent] = NA
                }
              }
              content <- data.frame(do.call(rbind,content))
              tables_names <- content[content$X1 == "Table", ]
              tables_names <- tables_names[-1, ]
              tables <- res[grep("Table",names(res))]
              tables <- tables[-1]
              plots_names <- content[content$X1 == "Plot", ]
              plots <- res[grep("Plot",names(res))]

              t=1
				if (length(tables)>0){					
              for (t in 1:length(tables)) {
                cat(paste0("\n_Summary table of ",tables_names[t,2]," LFD",ifelse(!is.na(tables_names[t,4]),paste0(" by ",tables_names[t,4]),"")," for ", SPs[s], " in ", GSAs[g], "_"))
                
                print(tables[[t]] %>% kable("html") %>% kable_styling(font_size = 12) %>% kable_classic(full_width = TRUE))
              } } else {
                cat(paste0("\n- No LFD available in landings for the selected combination: ", SPs[s], " - ", MS, " - ", GSAs[g], ".\n"))
              }

        x <- 1
		if (length(plots)>0){	
		    x=2
        for (x in 1:length(plots)) {
          if (plots_names[x,3]=="TOTAL LANDING") {
            # cat(paste0("\n_Plot of total landings for ", SPs[s], " in ", GSAs[g], "_"))
          } else {
            cat(paste0("\n_Plot of ",plots_names[x,2]," LDF",ifelse(!is.na(plots_names[x,4]),paste0(" by ",plots_names[x,4]),"")," for ", SPs[s], " in ", GSAs[g], "_"))
          suppressMessages(print(plots[[x]]))
          cat("\n\n\n")
          }

        }
		} else {
            cat(paste0("\n- No plot of LFD available for landings for the selected combination: ", SPs[s], " - ", MS, " - ", GSAs[g], ".\n"))
          }		
      } else {
        cat(paste0("\n- No LFD available in landings for the selected combination: ", SPs[s], " - ", MS, " - ", GSAs[g], ".\n"))
      }
      
      
    }
  }
} # check_Land
```




<!-- DISCARD -->

```{r check_discard_data, results = 'asis'}

if (exists("Disc")) {
  if (class(Disc) == "data.frame") {
    if (nrow(Disc) > 0) {
      check_Disc <- TRUE
      colnames(Disc) <- tolower(colnames(Disc))
      cat(paste0("\n# Discard table\n"))
      if (!user_SP) {
        SPs <- unique(Disc$species)
      }
      if (!user_MS) {
        MS <- unique(Disc$country)
      }
      if (!user_GSA) {
        GSAs <- unique(Disc$area)
      }
    }
  }
} else {
  check_Disc <- FALSE
  cat("\n No Discard data available \n")
}
```

```{r discards_duplicated_records, results = 'asis'}
if (check_Disc) {
  cat("\n## No replicated records in discard data \n")
  cat("\nData included in the discard table were checked for the presence of duplicated records. The result of the check is here reported:\n")

  duplicates <- Disc[0, ]

  for (g in 1:length(GSAs)) {
    s <- 1
    for (s in 1:length(SPs)) {
      res <- MEDBS_check_duplicates(data = Disc, type = "d", SP = SPs[s], MS = MS, GSA = GSAs[g], verbose = FALSE)
      if (!is.null(res)) {
        duplicates <- rbind(duplicates, res)
      }
    }
  }

  if (nrow(duplicates) > 0) {
    cat("\n", paste0("- _WARNING_ - ", nrow(duplicates), " replicated record/records in the data"), "\n")
    duplic <- data.frame(id = duplicates[, 1])
    print(duplic %>% kable("html") %>% kable_styling(font_size = 12) %>% kable_classic(full_width = TRUE))
    Disc <- Disc[-which(rownames(Disc) %in% as.numeric(rownames(duplicates))), ]
  } else {
    cat("\n", paste0("- No replicated records in Discard data"), "\n")
  }
} # check_Disc
```

```{r discards_disaggregated_records, results = 'asis'}
if (check_Disc) {
  cat("\n## Presence of disaggregated records\n")
  cat("\nData included in the discards table were checked for the presence of disaggregated records. The result of the check is here reported:\n")

  disaggregated <- Disc[0, ]

  g <- 1
  for (g in 1:length(GSAs)) {
    s <- 1
    for (s in 1:length(SPs)) {
      res <- MEDBS_check_disaggregated(data = Disc, type = "d", SP = SPs[s], MS = MS, GSA = GSAs[g], verbose = FALSE)
      if (!is.null(res)) {
        disaggregated <- rbind(disaggregated, res)
      }
    }
  }

  if (nrow(disaggregated) > 0) {
    cat("\n", paste0("- _WARNING_ - ", nrow(disaggregated), " disaggregated record/records in the data"), "\n")
    print(disaggregated %>% kable("html") %>% kable_styling(font_size = 12) %>% kable_classic(full_width = TRUE))
  } else {
    cat("\n", paste0("- No disaggregated records in discards data"), "\n")
  }

} # check_Disc
```


```{r disc_missing_years, results = 'asis'}
if (check_Disc) {
  cat("\n## Check missing years in time series\n")
  cat("\nDiscard data where checked for the continuity of the time series, identifying the presence of missing years:\n")

  g <- 1
  for (g in 1:length(GSAs)) {
    s <- 1
    for (s in 1:length(SPs)) {
      res <- MEDBS_check_missing_years(data = Disc,end_year, type = "d", SP = SPs[s], MS = MS, GSA = GSAs[g], verbose = FALSE)
      if (!is.null(res)) {
        if (length(res)>0) {
           cat(paste0("\n- The following years are missing in the discards data time series (", SPs[s], " - ", MS, " - ", GSAs[g], "): ",paste(res,collapse=", "),"\n"))
        } else {
          cat(paste0("\n- No missing years in the discards data time series for the selected combination: ", SPs[s], " - ", MS, " - ", GSAs[g], "\n")) }
      } else {
       cat(paste0("\n- No discards data for the selected combination: ", SPs[s], " - ", MS, " - ", GSAs[g], "\n"))
      }
    } # for cycle SP
  } # for cycle GSA
} # check_Disc
```


```{r discard_coverage, results = 'asis',fig.height=6,fig.width=9}
if (check_Disc) {
  cat("\n## Discards data time series\n")

  for (g in 1:length(GSAs)) {
    cat(paste0("\n### ", GSAs[g], "\n"))
    s <- 1
    for (s in 1:length(SPs)) {
      cat(paste0("\n#### ", SPs[s], "\n"))
      res <- suppressMessages(MEDBS_discard_coverage(Disc, SP = SPs[s], MS = MS, GSA = GSAs[g]))
      tab1 <- res[[1]]

      if (!is.null(res)) {
        tab1 <- aggregate(tab1$discards, by = list(tab1$country, tab1$year, tab1$area, tab1$gear, tab1$species), FUN = "sum")
        colnames(tab1) <- c("COUNTRY", "YEAR", "AREA", "GEAR", "SPECIES", "DISCARDS")
        if (nrow(tab1) > 0) {
          cat(paste0("\n_Coverage of discard data for ", SPs[s], " in ", GSAs[g], "_"))
          print(tab1 %>% kable("html") %>% kable_styling(font_size = 12) %>% kable_classic(full_width = TRUE))
          cat("\n\n\n")
        } else {
          cat("\n\n\n- No data for discards")
        }
        print(res[[2]])
        cat("\n\n\n")
      } else {
        cat(paste0("\n- No Discards data for the selected combination: ", SPs[s], " - ", MS, " - ", GSAs[g], "\n"))
      }
    }
  }
} # check_Disc
```

```{r comp_disc_YQ, results = 'asis', fig.height=6, fig.width=9}
if (check_Disc) {
  cat("\n## Comparison between discards in weight by quarter and year\n")
  cat("\nDiscard data by gear were aggragated by quarter and years (-1) and were compared to identify possible inconsistencies.\n")
 g=1
  for (g in 1:length(GSAs)) {
    cat(paste0("\n### ", GSAs[g], "\n"))
    s <- 1
    for (s in 1:length(SPs)) {
      cat(paste0("\n#### ", SPs[s], "\n"))
      res <- suppressMessages(MEDBS_comp_disc_YQ(data = Disc, MS = MS, GSA = GSAs[g], SP = SPs[s]))
      if (nrow(res) > 0) {
          res <- res[!is.na(res$RATIO) & res$RATIO >= 0.95 & res$RATIO <= 1.05,  ]
      }
      if (nrow(res) > 0) {
        cat(paste0("\n_Summary table of discard data aggregated by gear and both quarter and year for ", SPs[s], " in ", GSAs[g], "_"))
        print(res %>% kable("html") %>% kable_styling(font_size = 12) %>% kable_classic(full_width = TRUE))
      } else {
        cat(paste0("\n No table reported means that no issues were identified for the selected combination: ", SPs[s], " - ", MS, " - ", GSAs[g], "\n"))
      }
    }
  }
} # check_Disc
```

```{r comp_disc_YQ_fishery, results = 'asis', fig.height=6, fig.width=9}
if (check_Disc) {
  cat("\n## Comparison between discards in weight by quarter and year at metier level\n")
  cat("\nDiscard data by gear and fishery were aggragated by quarter and yeas and were compared to identify possible inconsistencies.\n")

  g <- 1
  for (g in 1:length(GSAs)) {
    cat(paste0("\n### ", GSAs[g], "\n"))
    s <- 1
    for (s in 1:length(SPs)) {
      cat(paste0("\n#### ", SPs[s], "\n"))
      res <- suppressMessages(MEDBS_comp_disc_YQ_fishery(data = Disc, MS = MS, GSA = GSAs[g], SP = SPs[s]))
      if (nrow(res) > 0) {
          res <- res[!is.na(res$RATIO) & res$RATIO >= 0.95 & res$RATIO <= 1.05,  ]
      }
      if (nrow(res) > 0) {
        cat(paste0("\n_Summary table of discard data aggregated by gear, fishery and both quarter and year for ", SPs[s], " in ", GSAs[g], "_"))
        print(res %>% kable("html") %>% kable_styling(font_size = 12) %>% kable_classic(full_width = TRUE))
      } else {
        cat(paste0("\n No table reported means that no issues were identified for the selected combination: ", SPs[s], " - ", MS, " - ", GSAs[g], "\n"))
      }
    }
  }
} # check_Disc
```

```{r disc_mean_weight, results = 'asis', fig.height=6, fig.width=9}
if (check_Disc) {
  cat("\n## Mean weight by year, gear and fishery aggregation\n")
  cat(paste0("\n Discard data were checked to assess the consistency of mean species discard weight by year, gear and fishery.\n"))

  for (g in 1:length(GSAs)) {
    cat(paste0("\n### ", GSAs[g], "\n"))
    s <- 1
    for (s in 1:length(SPs)) {
      cat(paste0("\n#### ", SPs[s], "\n"))
      res <- suppressMessages(MEDBS_disc_mean_weight(data = Disc, MS = MS, GSA = GSAs[g], SP = SPs[s]))
      if (class(res) == "list" & length(res) > 0) {
        if (!is.null(res[[1]])) {
          cat(paste0("\n_Summary table of Main discard weights for ", SPs[s], " in ", GSAs[g], "_"))
          print(res[[1]] %>% kable("html") %>% kable_styling(font_size = 12) %>% kable_classic(full_width = TRUE))
        }
        if (length(res) > 1) {
          cat(paste0("\nPlot of discard mean weights for ", SPs[s], " - ", MS, " - ", GSAs[g], "\n"))
          suppressMessages(print(res[[2]]))
          cat("\n\n\n")
        } else {
          cat(paste0("\n- No main weights estimated for the selected combination: ", SPs[s], " - ", MS, " - ", GSAs[g], ".\n"))
        }
      } else {
        cat(paste0("\n- No main weights estimated for the selected combination: ", SPs[s], " - ", MS, " - ", GSAs[g], ".\n"))
      }
    }
  }
} # check_Disc
```

```{r KS_test_disc, results = 'asis', fig.height=6, fig.width=9}

if (check_Disc) {
  cat("\n## Kolmogorov-Smirnov test\n")
  cat("\nThe Kolmogorov-Smirnov test provides cumulative length distribution plots by fishery and year. The test is performed on couples of years to assess if their distributions belong to the same population. The summary table reports only the cases in which the distribution does not belong to the same population in the given comparison.\n")

  for (g in 1:length(GSAs)) {
    cat(paste0("\n### ", GSAs[g], "\n"))
    s <- 2
    for (s in 1:length(SPs)) {
      cat(paste0("\n#### ", SPs[s], "\n"))
      res <- suppressMessages(MEDBS_ks(data = Disc, type = "d", SP = SPs[s], MS = MS, GSA = GSAs[g], Rt = Rt))

      if (class(res) == "list" & length(res) > 0) {
        if (!is.null(res[[4]])) {
          cat("\n\n\n")
          cat(paste0("\nPlot of cumulative length distributions by fishery and year for ", SPs[s], " - ", MS, " - ", GSAs[g], "\n"))
          plot(res[[4]])
          cat("\n\n\n")
          # if (!is.null(res[[2]])) {
          #   cat(paste0("\n_Summary table of Kolmogorov-Smirnov test for ", SPs[s], " in ", GSAs[g], "_\n"))
          #   tab1 <- res[[2]]
          #   tab1 <- tab1[tab1$Comment == "not belong to same population", ]
          #   print(tab1 %>% kable("html") %>% kable_styling(font_size = 12) %>% kable_classic(full_width = TRUE))
          # }
        } else {
          cat(paste0("\n- No Kolmogorov-Smirnov test results are available for the selected combination: ", SPs[s], " - ", MS, " - ", GSAs[g], ".\n"))
        }
      } else {
        cat(paste0("\n- No Kolmogorov-Smirnov test results are available for the selected combination: ", SPs[s], " - ", MS, " - ", GSAs[g], ".\n"))
      }
    }
  }
} # check_Disc
```

```{r length_ind_disc, results = 'asis', fig.height=6, fig.width=9}
if (check_Disc) {
  cat("\n## Main length size indicators\n")
  cat(paste0("\nThe time series of the main length size indicators (mean and median length) by fishery was estimated and hereafter reported: \n"))

  for (g in 1:length(GSAs)) {
    cat(paste0("\n### ", GSAs[g], "\n"))
    s <- 1
    for (s in 1:length(SPs)) {
      cat(paste0("\n#### ", SPs[s], "\n"))
      res <- suppressMessages(MEDBS_length_ind(data = Disc, type = "d", MS = MS, GSA = GSAs[g], SP = SPs[s], splines = c(0.2, 0.4, 0.6, 0.8), Xtresholds = c(0.25, 0.5, 0.75)))

      if (class(res) == "list" & length(res) > 0) {
        # cat(paste0("\n_Summary table of Main length size indicators for ", SPs[s], " in ", GSAs[g], "_"))
        # print(res[[1]] %>% kable("html") %>% kable_styling(font_size = 12) %>% kable_classic(full_width = TRUE))

        name <- names(res)
        list_name <- strsplit(name, " _ ")
        short_list <- NULL
        n <- 1
        for (n in 1:length(list_name)) {
          short_list[n] <- list_name[[n]][1]
        }
        index <- which(short_list %in% c("MeanLength", "MedianLength","25th.perc","75th.perc","MinLength","MaxLength"))

        x <- 3
        for (x in index) {
          text <- strsplit(name[[x]], " _ ")[[1]][1]
          cat(paste0("\nPlot of ", short_list[x], " for ", SPs[s], " - ", MS, " - ", GSAs[g], "\n"))
          suppressMessages(plot(res[[x]]))
          cat("\n\n\n")
        }
      } else {
        cat(paste0("\n- No main length size indicators estimated for the selected combination: ", SPs[s], " - ", MS, " - ", GSAs[g], ".\n"))
      }
    }
  }
} # check_Disc
```

```{r lengthclass_0_disc, results = 'asis', fig.height=6, fig.width=9}
if (check_Disc) {
  cat("\n## Check the number of records for which no demographic structure has been reported\n")
  cat("\nThe presence of length classes numbers zero having weigth > 0 in discards is here reported:\n")

  for (g in 1:length(GSAs)) {
    cat(paste0("\n### ", GSAs[g], "\n"))
    s <- 1
    for (s in 1:length(SPs)) {
      cat(paste0("\n#### ", SPs[s], "\n"))
      res <- suppressMessages(MEDBS_lengthclass_0(data = Disc, type = "d", MS = MS, GSA = GSAs[g], SP = SPs[s]))
      if (nrow(res) > 0) {
        ll <- Disc
        colnames(ll) <- tolower(colnames(ll))
        cat(paste0("\n_",nrow(res)," discard records in which length class numbers are 0 for ", SPs[s], " in ", GSAs[g], " over a total of ",nrow(ll[ll$country == MS & ll$area==GSAs[g] & ll$species ==SPs[s], ])," rows_"))
        # print(res %>% kable("html") %>% kable_styling(font_size = 12) %>% kable_classic(full_width = TRUE))
      } else {
        cat(paste0("\n- No discard records with 0 length class values having weigth > 0 for : ", SPs[s], " - ", MS, " - ", GSAs[g], "\n"))
      }
    }
  }
} # check_Disc
```

```{r yr_missing_length_disc, results = 'asis', fig.height=6, fig.width=9}
if (check_Disc) {
  cat("\n## Check the presence of years with missing length distribution\n")
  cat("\nDiscard data were checked to identify the presence of years with missing length distributions. The years with the missing length distribution are reported in the following table (if any):\n")

  g=1
  for (g in 1:length(GSAs)) {
    cat(paste0("\n### ", GSAs[g], "\n"))
    s <- 1
    for (s in 1:length(SPs)) {
      cat(paste0("\n#### ", SPs[s], "\n"))
      res <- suppressMessages(MEDBS_yr_missing_length(data = Disc, type = "d", MS = MS, GSA = GSAs[g], SP = SPs[s]))
      if (!is.null(res) & length(res)!=0) {
          
          if (!is.null(res[[1]])) {
              if (length(res)>1) {
               cat(paste0("\n- No length distributions available for the following years: ", ifelse(is.na(res[[2]][1]),"NONE",paste(res[[2]],collapse = ", ")), "\n"))
              }  else {
                  cat(paste0("\n- No years in discards with missing length distribution for the selected combination: ", SPs[s], " - ", MS, " - ", GSAs[g], ".\n"))
          }
          }
          
          
        if (!is.null(res[[1]])) {
          cat(paste0("\n_Metiers in which no length distribution is available for ", SPs[s], " in ", GSAs[g], "_"))
          print(res[[1]] %>% kable("html") %>% kable_styling(font_size = 12) %>% kable_classic(full_width = TRUE))
        } else {
          cat(paste0("\n- No metiers in discards with missing length distribution for : ", SPs[s], " - ", MS, " - ", GSAs[g], "\n"))
        }
      } else {
        cat(paste0("\n- No discards data available for: ", SPs[s], " - ", MS, " - ", GSAs[g], "\n"))
      }
    }
  }
} # check_Disc
```


```{r weight_0_disc, results = 'asis', fig.height=6, fig.width=9}
if (check_Disc) {
  cat("\n## Check discard in weight equal to 0 with length class filled in\n")
  cat("\nThe presence of rows in discards with 0 values in weights having length classes filled in is reported in the following table:\n")

  for (g in 1:length(GSAs)) {
    cat(paste0("\n### ", GSAs[g], "\n"))
    s <- 1
    for (s in 1:length(SPs)) {
      cat(paste0("\n#### ", SPs[s], "\n"))
      res <- MEDBS_weight_0(data = Disc, type = "d", MS = MS, GSA = GSAs[g], SP = SPs[s], verbose = FALSE)
      if (nrow(res) > 0) {
        cat(paste0("\n_Discard records in weight equal to 0 having length classes filled in for ", SPs[s], " in ", GSAs[g], "_"))
        print(res %>% kable("html") %>% kable_styling(font_size = 12) %>% kable_classic(full_width = TRUE))
      } else {
        cat(paste0("\n- No Discard records in weight equal to 0 having length classes filled in for : ", SPs[s], " - ", MS, " - ", GSAs[g], "\n"))
      }
    }
  }
} # check_Disc
```

```{r weight_minus1_disc, results = 'asis', fig.height=6, fig.width=9}
if (check_Disc) {
  cat("\n## Check discard in weight equal to -1 with length class filled in\n")
  cat("\nThe presence of rows in discards with -1 values in weights having length classes filled in is reported in the following table:\n")

  for (g in 1:length(GSAs)) {
    cat(paste0("\n### ", GSAs[g], "\n"))
    s <- 1
    for (s in 1:length(SPs)) {
      cat(paste0("\n#### ", SPs[s], "\n"))
      res <- MEDBS_weight_minus1(data = Disc, type = "d", MS = MS, GSA = GSAs[g], SP = SPs[s], verbose = FALSE)
      if (nrow(res) > 0) {
        cat(paste0("\n_Discard records in weight equal to -1 having length classes filled in for ", SPs[s], " in ", GSAs[g], "_"))
        print(res %>% kable("html") %>% kable_styling(font_size = 12) %>% kable_classic(full_width = TRUE))
      } else {
        cat(paste0("\n- No discard records in weight equal to -1 having length classes filled in for : ", SPs[s], " - ", MS, " - ", GSAs[g], "\n"))
      }
    }
  }
} # check_Disc
```

```{r plot_discard_ts, results = 'asis', fig.height=6, fig.width=9}
if (check_Disc) {
  cat("\n## Total discard time series by quarter\n")
  cat(paste0("\nTo identify possible inconsistencies in discard data, the species time series of discard volumes is here plotted by quarter.\n"))

  for (g in 1:length(GSAs)) {
    cat(paste0("\n### ", GSAs[g], "\n"))
    s <- 1
    for (s in 1:length(SPs)) {
      cat(paste0("\n#### ", SPs[s], "\n"))
      res <- suppressMessages(MEDBS_plot_discard_ts(data = Disc, MS = MS, GSA = GSAs[g], SP = SPs[s], by = "quarter"))

      if (length(res) > 0) {
        cat(paste0("\nPlot of total discards for ", SPs[s], " - ", MS, " - ", GSAs[g], "\n"))
        cat("\n\n")
        print(res)
        cat("\n\n\n")
      } else {
        cat(paste0("\n- No total discards time series estimated for the selected combination: ", SPs[s], " - ", MS, " - ", GSAs[g], ".\n"))
      }
    }
  }
} # check_Disc
```

```{r plot_disc_vol, results = 'asis', fig.height=6, fig.width=9}
if (check_Disc) {
  cat("\n## Total discard time series by gear and fishery\n")
  cat(paste0("\nTo identify possible inconsistencies in discard data, the species time series of discard volumes is here plotted by fishery and gear.\n"))

  for (g in 1:length(GSAs)) {
    cat(paste0("\n### ", GSAs[g], "\n"))
    s <- 1
    for (s in 1:length(SPs)) {
      cat(paste0("\n#### ", SPs[s], "\n"))
      res <- suppressMessages(MEDBS_plot_disc_vol(data = Disc, MS = MS, GSA = GSAs[g], SP = SPs[s]))

      if (length(res) > 0) {
        cat(paste0("\nPlot of total discards for ", SPs[s], " - ", MS, " - ", GSAs[g], "\n"))
        cat("\n\n\n")
        suppressMessages(print(res))
        cat("\n\n\n")
      } else {
        cat(paste0("\n- No total discard time series estimated for the selected combination: ", SPs[s], " - ", MS, " - ", GSAs[g], ".\n"))
      }
    }
  }
} # check_Disc
```

```{r plot_disc_LFD, results = 'asis', fig.height=6, fig.width=9}
if (check_Disc) {
  cat("\n## Discard Length Frequency Distribution\n")
  cat(paste0("\nTo identify possible inconsistencies in discards lengths structure, the species' LFDs are here plotted by fishery and year\n"))

  g <- 1
  for (g in 1:length(GSAs)) {
    cat(paste0("\n### ", GSAs[g], "\n"))
    s <- 1
    for (s in 1:length(SPs)) {
      cat(paste0("\n#### ", SPs[s], "\n"))
      res <- suppressMessages(MEDBS_LFD(data = Disc, data2=NA, type="d", MS = MS, GSA = GSAs[g], SP = SPs[s], OUT=FALSE, verbose = TRUE))



            if (class(res) == "list" & length(res) > 0) {

              content <- strsplit(names(res),"_")
              lcontent <- max(lengths(content))
              u=5
              for (u in 1:length(content)) {
                if (lengths(content[u])< lcontent){
                  content[[u]][(lengths(content[u])+1):lcontent] = NA
                }
              }
              content <- data.frame(do.call(rbind,content))
              tables_names <- content[content$X1 == "Table", ]
              tables_names <- tables_names[-1, ]
              tables <- res[grep("Table",names(res))]
              tables <- tables[-1]
              plots_names <- content[content$X1 == "Plot", ]
              plots <- res[grep("Plot",names(res))]

              t=1
			  if (length(tables)>0) {
              for (t in 1:length(tables)) {
                cat(paste0("\n_Summary table of ",tables_names[t,2]," LFD",ifelse(!is.na(tables_names[t,4]),paste0(" by ",tables_names[t,4]),"")," for ", SPs[s], " in ", GSAs[g], "_"))

                print(tables[[t]] %>% kable("html") %>% kable_styling(font_size = 12) %>% kable_classic(full_width = TRUE))
              }
			  } else {
                cat(paste0("\n- No LFD available in discards for the selected combination: ", SPs[s], " - ", MS, " - ", GSAs[g], ".\n"))
              }

        x <- 1
		if (length(plots)>0){
        for (x in 1:length(plots)) {
          if (plots_names[x,3]=="TOTAL DISCARDS") {
            # cat(paste0("\n_Plot of total discards for ", SPs[s], " in ", GSAs[g], "_"))
          } else {
            cat(paste0("\n_Plot of ",plots_names[x,2]," LDF",ifelse(!is.na(plots_names[x,4]),paste0(" by ",plots_names[x,4]),"")," for ", SPs[s], " in ", GSAs[g], "_"))
          suppressMessages(print(plots[[x]]))
          cat("\n\n\n")
          }

        }
		} else {
            cat(paste0("\n- No plots of LFD available for discards for the selected combination: ", SPs[s], " - ", MS, " - ", GSAs[g], ".\n"))
          }
      } else {
        cat(paste0("\n- No LFD available in discards for the selected combination: ", SPs[s], " - ", MS, " - ", GSAs[g], ".\n"))
      }


    }
  }
} # check_Disc
```

<!-- GROWTH PARAMETERS -->

```{r check_GP_data, results = 'asis'}

if (exists("GP")) {
  if (class(GP) == "data.frame") {
    if (nrow(GP) > 0) {
      check_GP <- TRUE
      colnames(GP) <- tolower(colnames(GP))
      cat(paste0("\n# Growth parameters (GP) table\n"))
      if (!user_SP) {
        SPs <- unique(GP$species)
      }
      if (!user_MS) {
        MS <- unique(GP$country)
      }
      if (!user_GSA) {
        GSAs <- unique(GP$area)
      }
    }
  }
} else {
  check_GP <- FALSE
  cat("\n No growth parameters (GP) data available \n")
}
```


```{r GP_duplicated_records, results = 'asis'}
if (check_GP) {
  cat("\n## Presence of duplicated records\n")
  cat("\nData included in the GP table were checked for the presence of duplicated records. The result of the check is here reported:\n")

  duplicates <- GP[0, ]

  g <- 1
  for (g in 1:length(GSAs)) {
    s <- 1
    for (s in 1:length(SPs)) {
      res <- MEDBS_check_duplicates(data = GP, type = "gp", SP = SPs[s], MS = MS, GSA = GSAs[g], verbose = FALSE)
      if (!is.null(res)) {
        duplicates <- rbind(duplicates, res)
      }
    }
  }

  if (nrow(duplicates) > 0) {
    cat("\n", paste0("- _WARNING_ - ", nrow(duplicates), " replicated record/records in the data"), "\n")
    duplic <- data.frame(duplicates)
    print(duplic %>% kable("html") %>% kable_styling(font_size = 12) %>% kable_classic(full_width = TRUE))
    GP <- GP[-which(rownames(GP) %in% as.numeric(rownames(duplicates))), ]
  } else {
    cat("\n", paste0("- No replicated records in GP data"), "\n")
  }

  cat("\n*Attention*: eventual duplicated records will be removed from GP data for the following analysis \n")
} # check_GP
```


```{r GP_checks, results = 'asis', fig.height=6, fig.width=9}

if (check_GP) {
  cat("\n## plots of the growth parameter\n")
  cat("\nData related to growth parameter are used to produce a plots of growth curves for the selected combination of species and GSAs by sexes.\n")

  for (g in 1:length(GSAs)) {
    cat(paste0("\n### ", GSAs[g], "\n"))
    s <- 1
    for (s in 1:length(SPs)) {
      cat(paste0("\n#### ", SPs[s], "\n"))
      res <- suppressMessages(MEDBS_GP_check(GP, SP = SPs[s], MS = MS, GSA = GSAs[g]))

      if (class(res) == "list" & length(res) > 0) {
        # cat(paste0("\n_Summary table of VBGF parameters for ", SPs[s], " in ", GSAs[g], "_"))
        # print(res[[1]] %>% kable("html") %>% kable_styling(font_size = 12) %>% kable_classic(full_width = TRUE))

        name <- names(res)
        list_name <- strsplit(name, " _ ")
        short_list <- NULL
        for (n in 1:length(list_name)) {
          short_list[n] <- list_name[[n]][1]
        }
        index <- which(short_list == "VBGF_cum")

        for (x in index) {
          text <- strsplit(name[[x]], " _ ")[[1]][5]
          cat(paste0("\nPlot of the VBGF parameter for ", SPs[s], " - ", MS, " - ", GSAs[g], " - ", text, "\n"))
          print(res[[x]])
          cat("\n\n\n")
        }
      } else {
        cat(paste0("\n- No VBGF parameters are available for the selected combination: ", SPs[s], " - ", MS, " - ", GSAs[g], ". (eventual -1 values in VBGF parameters were not considered)\n"))
      }
    }
  }
} # check_GP
```

```{r LW_checks, results = 'asis', fig.height=6, fig.width=9}
if (check_GP) {
  cat("\n## Plots of length-weight (LW) functions\n")

  for (g in 1:length(GSAs)) {
    cat(paste0("\n### ", GSAs[g], "\n"))
    s <- 1
    for (s in 1:length(SPs)) {
      cat(paste0("\n#### ", SPs[s], "\n"))
      res <- suppressMessages(MEDBS_LW_check(GP, SP = SPs[s], MS = MS, GSA = GSAs[g]))

      if (class(res) == "list" & length(res) > 0) {
        # cat(paste0("\n_Summary table of length-weight parameters for ", SPs[s], " in ", GSAs[g], "_"))
        # print(res[[1]] %>% kable("html") %>% kable_styling(font_size = 12) %>% kable_classic(full_width = TRUE))

        name <- names(res)
        list_name <- strsplit(name, " _ ")
        short_list <- NULL
        for (n in 1:length(list_name)) {
          short_list[n] <- list_name[[n]][1]
        }

        short_list2 <- NULL
        for (n in 1:length(list_name)) {
          short_list2[n] <- list_name[[n]][5]
        }

        index <- which(short_list == "LW_cum" & !is.na(short_list2))

        for (x in index) {
          text <- strsplit(name[[x]], " _ ")[[1]][5]
          cat(paste0("\nPlot of the length-weight parameters for ", SPs[s], " - ", MS, " - ", GSAs[g], " - ", text, "\n"))
          print(res[[x]])
          cat("\n\n\n")
        }
      } else {
        cat(paste0("\n- No length-weight parameters are available for the selected combination: ", SPs[s], " - ", MS, " - ", GSAs[g], ". (eventual -1 values in LW parameters were not considered)\n"))
      }
    }
  }
} # check_GP
```

<!-- MA -->

```{r check_MA_data, results = 'asis'}

if (exists("MA")) {
  if (class(MA) == "data.frame") {
    if (nrow(MA) > 0) {
      check_MA <- TRUE
      colnames(MA) <- tolower(colnames(MA))
      cat(paste0("\n# Maturity at Age (MA) table\n"))
      if (!user_SP) {
        SPs <- unique(MA$species)
      }
      if (!user_MS) {
        MS <- unique(MA$country)
      }
      if (!user_GSA) {
        GSAs <- unique(MA$area)
      }
    }
  }
} else {
  check_MA <- FALSE
  cat("\n No Maturity at Age (MA) data available \n")
}
```


```{r MA_duplicated_records, results = 'asis'}
if (check_MA) {
  cat("\n## Presence of duplicated records\n")
  cat("\nData included in the MA table were checked for the presence of duplicated records. The result of the check is here reported:\n")

  duplicates <- MA[0, ]

  g <- 1
  for (g in 1:length(GSAs)) {
    s <- 1
    for (s in 1:length(SPs)) {
      res <- MEDBS_check_duplicates(data = MA, type = "ma", SP = SPs[s], MS = MS, GSA = GSAs[g], verbose = FALSE)
      if (!is.null(res)) {
        duplicates <- rbind(duplicates, res)
      }
    }
  }

  if (nrow(duplicates) > 0) {
    cat("\n", paste0("- _WARNING_ - ", nrow(duplicates), " replicated record/records in the data"), "\n")
    duplic <- data.frame(duplicates)
    print(duplic %>% kable("html") %>% kable_styling(font_size = 12) %>% kable_classic(full_width = TRUE))
    MA <- MA[-which(rownames(MA) %in% as.numeric(rownames(duplicates))), ]
  } else {
    cat("\n", paste0("- No replicated records in MA data"), "\n")
  }

  cat("\n*Attention*: eventual duplicated records will be removed from MA data for the following analysis \n")
} # check_MA
```


```{r MA_checks, results = 'asis', fig.height=6, fig.width=9}

if (check_MA) {
  cat("\n## Plots of Maturity at Age (MA) data\n")
  g <- 1
  for (g in 1:length(GSAs)) {
    cat(paste0("\n### ", GSAs[g], "\n"))
    s <- 1
    for (s in 1:length(SPs)) {
      cat(paste0("\n#### ", SPs[s], "\n"))
      res <- suppressMessages(MEDBS_MA_check(MA, SP = SPs[s], MS = MS, GSA = GSAs[g]))

      if (class(res) == "list" & length(res) > 0) {
        # cat(paste0("\n_Summary table of percentage of matures at age for ", SPs[s], " in ", GSAs[g], "_"))
        # print(res[[1]] %>% kable("html") %>% kable_styling(font_size = 12) %>% kable_classic(full_width = TRUE))

        name <- names(res)
        list_name <- strsplit(name, " _ ")
        short_list <- NULL
        for (n in 1:length(list_name)) {
          short_list[n] <- list_name[[n]][1]
        }

        short_list2 <- NULL
        for (n in 1:length(list_name)) {
          short_list2[n] <- list_name[[n]][5]
        }

        index <- which(short_list == "MA_sex" & !is.na(short_list2))

        for (x in index) {
          text <- strsplit(name[[x]], " _ ")[[1]][5]
          cat(paste0("\nPlot of the percercentage of matures at age for ", SPs[s], " - ", MS, " - ", GSAs[g], " - ", text, "\n"))
          print(res[[x]])
          cat("\n\n\n")
        }
      } else {
        cat(paste0("\n- No MA data are available for the selected combination: ", SPs[s], " - ", MS, " - ", GSAs[g], ".\n"))
      }
    }
  }
} # check_MA
```

<!-- ML -->

```{r check_ML_data, results = 'asis'}

if (exists("ML")) {
  if (class(ML) == "data.frame") {
    if (nrow(ML) > 0) {
      check_ML <- TRUE
      colnames(ML) <- tolower(colnames(ML))
      cat(paste0("\n# Maturity at Length (ML) table\n"))
      if (!user_SP) {
        SPs <- unique(ML$species)
      }
      if (!user_MS) {
        MS <- unique(ML$country)
      }
      if (!user_GSA) {
        GSAs <- unique(ML$area)
      }
    }
  }
} else {
  check_ML <- FALSE
  cat("\n No Maturity at Length (ML) data available \n")
}
```


```{r ML_duplicated_records, results = 'asis'}
if (check_ML) {
  cat("\n## Presence of duplicated records\n")
  cat("\nData included in the ML table were checked for the presence of duplicated records. The result of the check is here reported:\n")

  duplicates <- ML[0, ]

  g <- 1
  for (g in 1:length(GSAs)) {
    s <- 1
    for (s in 1:length(SPs)) {
      res <- MEDBS_check_duplicates(data = ML, type = "ml", SP = SPs[s], MS = MS, GSA = GSAs[g], verbose = FALSE)
      if (!is.null(res)) {
        duplicates <- rbind(duplicates, res)
      }
    }
  }

  if (nrow(duplicates) > 0) {
    cat("\n", paste0("- _WARNING_ - ", nrow(duplicates), " replicated record/records in the data"), "\n")
    duplic <- data.frame(duplicates)
    print(duplic %>% kable("html") %>% kable_styling(font_size = 12) %>% kable_classic(full_width = TRUE))
    ML <- ML[-which(rownames(ML) %in% as.numeric(rownames(duplicates))), ]
  } else {
    cat("\n", paste0("- No replicated records in ML data"), "\n")
  }

  cat("\n*Attention*: eventual duplicated records will be removed from ML data for the following analysis \n")
} # check_ML
```


```{r ML_checks, results = 'asis', fig.height=6, fig.width=9}

if (check_ML) {
  cat("\n## Plots of Maturity at Length (ML) data\n")

  for (g in 1:length(GSAs)) {
    cat(paste0("\n### ", GSAs[g], "\n"))
    s <- 1
    for (s in 1:length(SPs)) {
      cat(paste0("\n#### ", SPs[s], "\n"))
      res <- suppressMessages(MEDBS_ML_check(ML, SP = SPs[s], MS = MS, GSA = GSAs[g]))

      if (class(res) == "list" & length(res) > 0) {
        # cat(paste0("\n_Summary table of percentage of matures at length for ", SPs[s], " in ", GSAs[g], "_"))
        # print(res[[1]] %>% kable("html") %>% kable_styling(font_size = 12) %>% kable_classic(full_width = TRUE))

        name <- names(res)
        list_name <- strsplit(name, " _ ")
        short_list <- NULL
        for (n in 1:length(list_name)) {
          short_list[n] <- list_name[[n]][1]
        }

        short_list2 <- NULL
        for (n in 1:length(list_name)) {
          short_list2[n] <- list_name[[n]][5]
        }

        index <- which(short_list == "ML" & !is.na(short_list2))

        x <- 3
        for (x in index) {
          text <- strsplit(name[[x]], " _ ")[[1]][5]
          cat(paste0("\nPlot of the percercentage of matures at length for ", SPs[s], " - ", MS, " - ", GSAs[g], " - ", text, "\n"))
          print(res[[x]])
          cat("\n\n\n")
        }
      } else {
        cat(paste0("\n- No ML data are available for the selected combination: ", SPs[s], " - ", MS, " - ", GSAs[g], ".\n"))
      }
    }
  }
} # check_ML
```

<!-- SRA -->

```{r check_SRA_data, results = 'asis'}

if (exists("SA")) {
  if (class(SA) == "data.frame") {
    if (nrow(SA) > 0) {
      check_SRA <- TRUE
      colnames(SA) <- tolower(colnames(SA))
      cat(paste0("\n# Sex Ratio at age (SRA) table\n"))
      if (!user_SP) {
        SPs <- unique(SA$species)
      }
      if (!user_MS) {
        MS <- unique(SA$country)
      }
      if (!user_GSA) {
        GSAs <- unique(SA$area)
      }
    }
  }
} else {
  check_SRA <- FALSE
  cat("\n No Sex Ratio at age (SRA) data available \n")
}
```


```{r SRA_duplicated_records, results = 'asis'}
if (check_SRA) {
  cat("\n## Presence of duplicated records\n")
  cat("\nData included in the SRA table were checked for the presence of duplicated records. The result of the check is here reported:\n")

  duplicates <- SA[0, ]

  g <- 1
  for (g in 1:length(GSAs)) {
    s <- 1
    for (s in 1:length(SPs)) {
      res <- MEDBS_check_duplicates(data = SA, type = "sra", SP = SPs[s], MS = MS, GSA = GSAs[g], verbose = FALSE)
      if (!is.null(res)) {
        duplicates <- rbind(duplicates, res)
      }
    }
  }

  if (nrow(duplicates) > 0) {
    cat("\n", paste0("- _WARNING_ - ", nrow(duplicates), " replicated record/records in the data"), "\n")
    duplic <- data.frame(duplicates)
    print(duplic %>% kable("html") %>% kable_styling(font_size = 12) %>% kable_classic(full_width = TRUE))
    SA <- SA[-which(rownames(SA) %in% as.numeric(rownames(duplicates))), ]
  } else {
    cat("\n", paste0("- No replicated records in SRA data"), "\n")
  }

  cat("\n*Attention*: eventual duplicated records will be removed from SRA data for the following analysis \n")
} # check_SRA
```


```{r SA_checks, results = 'asis', fig.height=6, fig.width=9}
if (check_SRA) {
  cat("\n## Plots of Sex Ratio at age (SRA) data\n")

  for (g in 1:length(GSAs)) {
    cat(paste0("\n### ", GSAs[g], "\n"))
    s <- 1
    for (s in 1:length(SPs)) {
      cat(paste0("\n#### ", SPs[s], "\n"))
      res <- suppressMessages(MEDBS_SA_check(SA, SP = SPs[s], MS = MS, GSA = GSAs[g]))
      if (class(res) == "list" & length(res) > 0) {
        # cat(paste0("\n_Summary table of sex ratio at age for ", SPs[s], " in ", GSAs[g], "_"))
        # print(res[[1]] %>% kable("html") %>% kable_styling(font_size = 12) %>% kable_classic(full_width = TRUE))

        cat(paste0("\nPlot of sex ratio at age for ", SPs[s], " - ", MS, " - ", GSAs[g], "\n"))
        print(res[[2]])
        cat("\n\n\n")
      } else {
        cat(paste0("\n- No SRA data are available for the selected combination: ", SPs[s], " - ", MS, " - ", GSAs[g], ".\n"))
      }
    }
  }
} # check_SA
```

<!-- SL -->

```{r check_SL_data, results = 'asis'}

if (exists("SL")) {
  if (class(SL) == "data.frame") {
    if (nrow(SL) > 0) {
      check_SRL <- TRUE
      colnames(SL) <- tolower(colnames(SL))
      cat(paste0("\n# Sex Ratio at length (SRL) table\n"))
      if (!user_SP) {
        SPs <- unique(SL$species)
      }
      if (!user_MS) {
        MS <- unique(SL$country)
      }
      if (!user_GSA) {
        GSAs <- unique(SL$area)
      }
    }
  }
} else {
  check_SRL <- FALSE
  cat("\n No Sex Ratio at length (SRL) data available \n")
}
```


```{r SRL_duplicated_records, results = 'asis'}
if (check_SRL) {
  cat("\n## Presence of duplicated records\n")
  cat("\nData included in the SRL table were checked for the presence of duplicated records. The result of the check is here reported:\n")

  duplicates <- SL[0, ]

  g <- 1
  for (g in 1:length(GSAs)) {
    s <- 1
    for (s in 1:length(SPs)) {
      res <- MEDBS_check_duplicates(data = SL, type = "srl", SP = SPs[s], MS = MS, GSA = GSAs[g], verbose = FALSE)
      if (!is.null(res)) {
        duplicates <- rbind(duplicates, res)
      }
    }
  }

  if (nrow(duplicates) > 0) {
    cat("\n", paste0("- _WARNING_ - ", nrow(duplicates), " replicated record/records in the data"), "\n")
    duplic <- data.frame(duplicates)
    print(duplic %>% kable("html") %>% kable_styling(font_size = 12) %>% kable_classic(full_width = TRUE))
    SL <- SL[-which(rownames(SL) %in% as.numeric(rownames(duplicates))), ]
  } else {
    cat("\n", paste0("- No replicated records in SRL data"), "\n")
  }

  cat("\n*Attention*: eventual duplicated records will be removed from SRL data for the following analysis \n")
} # check_SRL
```


```{r SL_checks, results = 'asis', fig.height=6, fig.width=9}

if (check_SRL) {
  cat("\n## Plots of Sex Ratio at length (SRL) data\n")

  for (g in 1:length(GSAs)) {
    cat(paste0("\n### ", GSAs[g], "\n"))
    s <- 1
    for (s in 1:length(SPs)) {
      cat(paste0("\n#### ", SPs[s], "\n"))
      res <- suppressMessages(MEDBS_SL_check(SL, SP = SPs[s], MS = MS, GSA = GSAs[g]))
      if (class(res) == "list" & length(res) > 0) {
        # cat(paste0("\n_Summary table of sex ratio at length for ", SPs[s], " in ", GSAs[g], "_"))
        # print(res[[1]] %>% kable("html") %>% kable_styling(font_size = 12) %>% kable_classic(full_width = TRUE))

        cat(paste0("\nPlot of sex ratio at length for ", SPs[s], " - ", MS, " - ", GSAs[g], "\n"))
        print(res[[2]])
        cat("\n\n\n")
      } else {
        cat(paste0("\n- No SRL data are available for the selected combination: ", SPs[s], " - ", MS, " - ", GSAs[g], ".\n"))
      }
    }
  }
} # check_SRL
```

<!-- ALK -->

```{r check_ALK_data, results = 'asis'}

if (exists("ALK")) {
  if (class(ALK) == "data.frame") {
    if (nrow(ALK) > 0) {
      check_ALK <- TRUE
      colnames(ALK) <- tolower(colnames(ALK))
      cat(paste0("\n# Age-Length Keys (ALK) table\n"))
      if (!user_SP) {
        SPs <- unique(ALK$species)
      }
      if (!user_MS) {
        MS <- unique(ALK$country)
      }
      if (!user_GSA) {
        GSAs <- unique(ALK$area)
      }
    }
  }
} else {
  check_ALK <- FALSE
  cat("\n No Age-Length Keys (ALK) data available \n")
}
```



```{r ALK_duplicated_records, results = 'asis'}
if (check_ALK) {
  cat("\n## Presence of duplicated records\n")
  cat("\nData included in the ALK table were checked for the presence of duplicated records. The results of the check are here reported:\n")

  duplicates <- ALK[0, ]

  g <- 1
  for (g in 1:length(GSAs)) {
    s <- 1
    for (s in 1:length(SPs)) {
      res <- MEDBS_check_duplicates(data = ALK, type = "alk", SP = SPs[s], MS = MS, GSA = GSAs[g], verbose = FALSE)
      if (!is.null(res)) {
        duplicates <- rbind(duplicates, res)
      }
    }
  }

  if (nrow(duplicates) > 0) {
    cat("\n", paste0("- _WARNING_ - ", nrow(duplicates), " replicated record/records in the data"), "\n")
    duplic <- data.frame(duplicates)
    print(duplic %>% kable("html") %>% kable_styling(font_size = 12) %>% kable_classic(full_width = TRUE))
    ALK <- ALK[-which(rownames(ALK) %in% as.numeric(rownames(duplicates))), ]
  } else {
    cat("\n", paste0("- No replicated records in ALK data"), "\n")
  }

  cat("\n*Attention*: eventual duplicated records will be removed from ALK data for the following analysis \n")
} # check_ALK
```


```{r ALK_checks, results = 'asis', fig.height=6, fig.width=9}

if (check_ALK) {
  cat("\n## Plots of Age-Length Keys (ALK) data\n")

  for (g in 1:length(GSAs)) {
    cat(paste0("\n### ", GSAs[g], "\n"))
    s <- 1
    for (s in 1:length(SPs)) {
      cat(paste0("\n#### ", SPs[s], "\n"))
      res <- suppressMessages(MEDBS_ALK(ALK, SP = SPs[s], MS = MS, GSA = GSAs[g]))

      if (class(res) == "list" & length(res) > 0) {
        l <- 1
        for (l in 1:length(res)) {
          sex <- strsplit(names(res[l]), " - ")[[1]][1]
          cat(paste0("\nPlot of ALK for ", SPs[s], " - ", MS, " - ", GSAs[g], " - ", sex, "\n"))
          print(res[[l]])
          cat("\n\n\n")
        }
      } else {
        cat(paste0("\n- No ALK data are available for the selected combination: ", SPs[s], " - ", MS, " - ", GSAs[g], ".\n"))
      }
    }
  }
} # check_ALK
```
